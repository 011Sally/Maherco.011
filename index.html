<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maherco.Challenges</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
            color: #fff;
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
        }

        /* Ø§Ù„Ù†ÙŠØ§Ø²Ùƒ ÙˆØ§Ù„Ù†Ø¬ÙˆÙ… */
        .star {
            position: fixed;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            background: linear-gradient(135deg, #FFD700, #FFA500, #FFEB3B);
            box-shadow: 
                0 0 30px #FFD700,
                0 0 60px rgba(255, 215, 0, 0.8),
                inset 0 0 15px rgba(255, 255, 255, 0.9);
            animation: starPulse 3s infinite ease-in-out;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes starPulse {
            0%, 100% { 
                opacity: 0.6; 
                transform: scale(0.8) rotate(0deg);
            }
            50% { 
                opacity: 1; 
                transform: scale(1.5) rotate(180deg);
            }
        }

        .meteor {
            position: fixed;
            width: 3px;
            height: 3px;
            background: linear-gradient(to bottom, transparent, #FFD700, #FFA500);
            border-radius: 50%;
            pointer-events: none;
            z-index: 2;
        }

        .meteor::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100px;
            height: 2px;
            background: linear-gradient(to left, transparent, #FFD700, #FFA500);
            transform: translateX(-100px);
            border-radius: 50%;
        }

        @keyframes meteorFall {
            0% {
                transform: translateY(-100px) translateX(0) rotate(45deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) translateX(100px) rotate(45deg);
                opacity: 0;
            }
        }

        .container {
            position: relative;
            z-index: 10;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            min-height: calc(100vh - 80px);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn-primary {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
        }

        .btn-back {
            background: #F59E0B;
            color: #fff;
        }

        .btn-logout {
            background: #EF4444;
            color: #fff;
        }

        .btn-success {
            background: #10B981;
            color: #fff;
        }

        .btn-danger {
            background: #EF4444;
            color: #fff;
        }

        .btn-info {
            background: #3B82F6;
            color: #fff;
        }

        .btn-disabled {
            background: #6B7280 !important;
            cursor: not-allowed !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-box {
            background: rgba(0,0,0,0.3);
            padding: 40px;
            border-radius: 30px;
            border: 2px solid #FFD700;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.3);
            width: 100%;
            max-width: 400px;
        }

        .input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid #FFD700;
            border-radius: 15px;
            background: #1F2937;
            color: #fff;
            font-size: 1rem;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }

        .menu-item {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
            border: none;
            color: #000;
            font-weight: bold;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .menu-item:hover {
            transform: scale(1.1);
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.8);
            opacity: 1;
        }

        .wheel-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }

        .wheel-wrapper {
            position: relative;
            width: 400px;
            height: 400px;
        }

        #wheel {
            width: 100%;
            height: 100%;
            transition: transform 6s cubic-bezier(0.17, 0.67, 0.12, 0.99); 
            cursor: pointer;
        }

        .wheel-pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 20px solid #EF4444;
            z-index: 10;
        }

        .wheel-info {
            text-align: center;
            font-size: 1.5rem;
            color: #FFD700;
        }

        .card {
            background: rgba(0,0,0,0.3);
            padding: 25px;
            border-radius: 20px;
            border: 2px solid #FFD700;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.8rem;
            color: #FFD700;
            margin-bottom: 15px;
        }

        .list-item {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #FFD700;
        }

        .player-rank {
            font-size: 2rem;
            font-weight: bold;
            margin-left: 20px;
        }

        .rank-1 { color: #FFD700; }
        .rank-2 { color: #C0C0C0; }
        .rank-3 { color: #CD7F32; }

        .settings-grid {
            display: grid;
            gap: 15px;
            margin-top: 30px;
        }

        .settings-btn {
            background: rgba(0,0,0,0.3);
            border: 2px solid #FFD700;
            padding: 20px;
            border-radius: 15px;
            color: #fff;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .settings-btn:hover {
            background: rgba(0,0,0,0.3);
            transform: translateX(-5px);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #FFD700;
            font-weight: bold;
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #FFD700;
            border-radius: 10px;
            background: #1F2937;
            color: #fff;
            font-size: 1rem;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #FFD700;
            border-radius: 10px;
            background: #1F2937;
            color: #fff;
            font-size: 1rem;
            min-height: 120px;
            resize: vertical;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        .btn-group .btn {
            flex: 1;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .title {
                font-size: 1.8rem;
            }

            .wheel-wrapper {
                width: 300px;
                height: 300px;
            }

            .menu-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .spinner {
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-top: 3px solid #FFD700;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .text-center {
            text-align: center;
        }

        .text-gray {
            color: #9CA3AF;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-4 {
            gap: 1rem;
        }

        .points-input-panel {
            background: rgba(0,0,0,0.3);
            border: 3px solid #FFD700;
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .points-input-panel h3 {
            color: #FFD700;
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .points-input-item {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            border: 1px solid #FFD700;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .points-input-item input {
            width: 120px;
            padding: 10px;
            border: 2px solid #FFD700;
            border-radius: 8px;
            background: #1F2937;
            color: #fff;
            font-size: 1.1rem;
            text-align: center;
        }

        .player-challenges-list {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .challenge-item {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 3px solid #FFD700;
        }

        .warning-message {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #EF4444;
            border-radius: 15px;
            padding: 20px;
            margin: 20px auto;
            max-width: 500px;
            text-align: center;
        }

        .start-challenge-text {
            font-size: 2rem;
            color: #FFD700;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.7);
            cursor: pointer;
            transition: all 0.3s;
        }

        .start-challenge-text:hover {
            transform: scale(1.1);
            text-shadow: 0 0 30px rgba(255, 215, 0, 1);
        }

        .challenge-warning {
            background: rgba(239, 68, 68, 0.3);
            border: 3px solid #EF4444;
            color: #fff;
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ù†ØªÙŠØ¬Ø© */
        .result-banner {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            z-index: 1001;
            transition: top 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.7);
            min-width: 300px;
            text-align: center;
        }

        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¥Ù†Ø³ØªØºØ±Ø§Ù…  */
        .footer-instagram {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, #833AB4, #FD1D1D, #FCB045);
            padding: 10px 20px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(253, 29, 29, 0.5);
            border: 2px solid #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .footer-instagram:hover {
            transform: scale(1.05);
            filter: brightness(1.2);
        }

        .footer-instagram span {
            color: white;
            font-weight: bold;
            font-size: 1rem;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        /* Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Firebase */
        .firebase-status {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1005;
            padding: 10px 15px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .firebase-connected {
            background: rgba(16, 185, 129, 0.9);
            color: #fff;
        }

        .firebase-disconnected {
            background: rgba(239, 68, 68, 0.9);
            color: #fff;
        }

        .firebase-syncing {
            background: rgba(59, 130, 246, 0.9);
            color: #fff;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="firebase-status" class="firebase-status firebase-syncing" style="display: none;">
        Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase...
    </div>

    <script type="module">
        // ğŸ”¥ğŸ“¦ IMPORTS FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            onSnapshot,
            serverTimestamp,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        // ğŸ¯ Firebase Configuration (Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù‡Ù†Ø§!)
        const firebaseConfig = {
        apiKey: "AIzaSyBygeSoDg91pROjFOPsEVCC  6lUvGiRFc4",
        authDomain: "sally011-66076.firebaseapp.com",
       projectId: "sally011-66076",
        storageBucket: "sally011-66076.firebasestorage.app",
        messagingSenderId: "410513539798",
        appId: "1:410513539798:web:76bcfc3c2479768543bf77"
        };

        // ğŸ”¥ Initialize Firebase
        const firebaseApp = initializeApp(firebaseConfig);
        const db = getFirestore(firebaseApp);

        // ğŸ“¡ Collection & Document References
        const publicDataRef = doc(db, 'public', 'data');

        // ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (ØªÙÙ…Ù„Ø£ Ù…Ù† Firebase)
        const appData = {
            currentUser: null,
            currentPage: 'login',
            pageHistory: [],
            siteName: 'maherco',
            games: [],
            players: [],
            cards: [],
            users: [],
            currentChallenges: [],
            savedChallenges: [],
            notes: [],
            wheelStep: 'games',
            selectedGame: null,
            currentChallenge: null,
            availablePlayers: [],
            availableCards: [],
            rotation: 0,
            isSpinning: false,
            selectedPlayer: null,
            soundEnabled: true,
            musicEnabled: false,
            firebaseLoaded: false,
            firebaseError: null
        };

        // ğŸµ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙˆØª
        const audioElement = document.createElement('audio');
        audioElement.id = 'wheel-audio';
        audioElement.preload = 'auto';
        audioElement.style.display = 'none';
        audioElement.src = 'wheel-voice.mp3';

        const musicElement = document.createElement('audio');
        musicElement.id = 'background-music';
        musicElement.loop = true;
        musicElement.style.display = 'none';
        musicElement.src = 'Interstellar.mp3';

        // ğŸ“¡ Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Firebase
        function updateFirebaseStatus(status, message) {
            const statusEl = document.getElementById('firebase-status');
            if (!statusEl) return;
            
            statusEl.className = `firebase-status firebase-${status}`;
            if (message) statusEl.textContent = message;
            
            if (status === 'connected' || status === 'disconnected' || status === 'syncing') {
                statusEl.style.display = 'block';
                if (status === 'connected') {
                    setTimeout(() => statusEl.style.display = 'none', 3000);
                }
            }
        }

        // ğŸ’¾ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„)
        async function loadDataFromFirebase() {
            try {
                updateFirebaseStatus('syncing', 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
                const docSnap = await getDoc(publicDataRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø£Ù…Ø§Ù†
                    safeMerge(appData, data);
                    
                    // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† localStorage
                    loadUserSession();
                    
                    appData.firebaseLoaded = true;
                    updateFirebaseStatus('connected', 'âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase');
                    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase');
                    
                    // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ©
                    listenToFirebaseChanges();
                } else {
                    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙ†Ø¯ Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯
                    await initializeFirebaseData();
                    updateFirebaseStatus('connected', 'âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                }
                
                render();
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Firebase:', error);
                appData.firebaseError = error.message;
                updateFirebaseStatus('disconnected', 'âš ï¸ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase');
                
                // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
                setTimeout(() => {
                    if (!appData.firebaseLoaded) {
                        loadDataFromFirebase();
                    }
                }, 3000);
            }
        }

        // ğŸ“¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ©
        function listenToFirebaseChanges() {
            onSnapshot(publicDataRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const currentPage = appData.currentPage;
                    const currentUser = appData.currentUser;
                    
                    // Ø¯Ù…Ø¬ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
                    safeMerge(appData, data);
                    
                    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ù„Ø³Ø©
                    appData.currentPage = currentPage;
                    appData.currentUser = currentUser;
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ØµÙØ­Ø© Ø¹Ø§Ù…Ø©
                    if (currentPage !== 'login' && currentPage !== 'home') {
                        render();
                    }
                    
                    updateFirebaseStatus('connected', 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                }
            });
        }

        // ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙ†Ø¯ Firebase Ø£ÙˆÙ„ÙŠ
        async function initializeFirebaseData() {
            const initialData = {
                games: [],
                players: [{ id: 1, name: 'Player1', points: 0, challenges: 0, cards: 0, instagram: '', challengeHistory: [] }],
                cards: [],
                users: [{ id: 1, username: 'Maherco', password: '709030', type: 'admin', createdAt: new Date().toISOString() }],
                currentChallenges: [],
                savedChallenges: [],
                notes: [],
                siteName: 'maherco',
                soundEnabled: true,
                musicEnabled: false,
                lastUpdated: serverTimestamp()
            };
            
            await setDoc(publicDataRef, initialData);
        }

        // ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Firebase
        async function saveDataToFirebase() {
            try {
                const dataToSave = {
                    games: appData.games,
                    players: appData.players,
                    cards: appData.cards,
                    users: appData.users,
                    currentChallenges: appData.currentChallenges,
                    savedChallenges: appData.savedChallenges,
                    notes: appData.notes,
                    siteName: appData.siteName,
                    soundEnabled: appData.soundEnabled,
                    musicEnabled: appData.musicEnabled,
                    lastUpdated: serverTimestamp()
                };
                
                await setDoc(publicDataRef, dataToSave);
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Firebase');
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Firebase:', error);
                updateFirebaseStatus('disconnected', 'âš ï¸ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firebase');
            }
        }

        // ğŸ—‘ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ø¯Ø¯Ø© ÙÙ‚Ø· (Ù„Ù„ØªØ­Ø³ÙŠÙ†)
        async function savePartialData(dataToUpdate) {
            try {
                await setDoc(publicDataRef, dataToUpdate, { merge: true });
                console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©');
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©:', error);
            }
        }

        // ğŸ’¾ Ø¯Ø§Ù„Ø© Ø¢Ù…Ù†Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…)
        function saveData() {
            // Ù„Ù† Ù†Ø­ÙØ¸ ÙÙŠ localStorage Ø¨Ø¹Ø¯ Ø§Ù„Ø¢Ù†
            // saveDataToFirebase() ØªÙØ³ØªØ¯Ø¹Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ ÙƒÙ„ ØªØ¹Ø¯ÙŠÙ„
        }

        // ğŸ”„ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¯Ù…Ø¬ Ø§Ù„Ø¢Ù…Ù†
        function safeMerge(target, source) {
            if (!source || typeof source !== 'object') return;
            
            const reservedKeys = ['currentUser', 'currentPage', 'pageHistory', 'wheelStep', 'selectedGame', 'currentChallenge', 'availablePlayers', 'availableCards', 'rotation', 'isSpinning', 'selectedPlayer', 'firebaseLoaded', 'firebaseError'];
            
            Object.keys(target).forEach(key => {
                if (!reservedKeys.includes(key) && source.hasOwnProperty(key)) {
                    if (Array.isArray(target[key]) && Array.isArray(source[key])) {
                        target[key] = [...source[key]];
                    } else if (typeof target[key] === 'object' && typeof source[key] === 'object' && target[key] !== null) {
                        safeMerge(target[key], source[key]);
                    } else {
                        target[key] = source[key];
                    }
                }
            });
        }

        // ğŸ‘¤ ØªØ­Ù…ÙŠÙ„ Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        function loadUserSession() {
            const savedUser = localStorage.getItem('MahercoCurrentUser');
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                const user = appData.users.find(u => u.username === userData.username);
                if (user) {
                    appData.currentUser = user;
                    appData.currentPage = 'home';
                }
            }
            
            const savedSound = localStorage.getItem('MahercoSoundEnabled');
            if (savedSound !== null) {
                appData.soundEnabled = JSON.parse(savedSound);
            }
            
            const savedMusic = localStorage.getItem('MahercoMusicEnabled');
            if (savedMusic !== null) {
                appData.musicEnabled = JSON.parse(savedMusic);
            }
        }

        // ğŸ“ Ø­ÙØ¸ Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        function saveUserSession() {
            if (appData.currentUser) {
                localStorage.setItem('MahercoCurrentUser', JSON.stringify({
                    username: appData.currentUser.username,
                    loginTime: new Date().toISOString()
                }));
            }
            localStorage.setItem('MahercoSoundEnabled', JSON.stringify(appData.soundEnabled));
            localStorage.setItem('MahercoMusicEnabled', JSON.stringify(appData.musicEnabled));
        }

        // ğŸµ Ø¯ÙˆØ§Ù„ Ø§Ù„ØµÙˆØª
        function playWheelSound() {
            if (!appData.soundEnabled) return;
            
            try {
                const audio = document.getElementById('wheel-audio');
                if (audio) {
                    audio.currentTime = 0;
                    audio.play().catch(e => console.log('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:', e));
                }
            } catch (e) {
                console.log('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠ:', e);
            }
        }

        function toggleMusic() {
            const music = document.getElementById('background-music');
            
            if (!music) return;
            
            if (music.paused) {
                music.currentTime = 0;
                music.play().catch(e => console.log('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰:', e));
                appData.musicEnabled = true;
            } else {
                music.pause();
                music.currentTime = 0;
                appData.musicEnabled = false;
            }
            
            saveUserSession();
            saveDataToFirebase();
            render();
        }

        function toggleSound(enabled) {
            appData.soundEnabled = enabled;
            saveUserSession();
            saveDataToFirebase();
            render();
        }

        // ğŸ¨ Ø§Ù„Ù†ÙŠØ§Ø²Ùƒ ÙˆØ§Ù„Ù†Ø¬ÙˆÙ…
        function createSparkles() {
            setInterval(() => {
                for (let i = 0; i < 3; i++) {
                    if (Math.random() > 0.5) {
                        setTimeout(() => {
                            const star = document.createElement('div');
                            star.className = 'star';
                            star.style.left = Math.random() * 100 + '%';
                            star.style.top = Math.random() * 100 + '%';
                            star.style.width = (Math.random() * 6 + 4) + 'px';
                            star.style.height = star.style.width;
                            star.style.animationDuration = (Math.random() * 2 + 2) + 's';
                            document.body.appendChild(star);
                            
                            setTimeout(() => star.remove(), 5000 + Math.random() * 3000);
                        }, i * 200);
                    }
                }
            }, 800);
        }

        function createMeteorShower() {
            const colors = [
                'linear-gradient(to bottom, transparent, #FFD700, #FFA500)',
                'linear-gradient(to bottom, transparent, #FF69B4, #FF1493)',
                'linear-gradient(to bottom, transparent, #00FFFF, #0080FF)',
                'linear-gradient(to bottom, transparent, #FF6347, #FF4500)',
                'linear-gradient(to bottom, transparent, #9370DB, #8A2BE2)'
            ];
            
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const meteor = document.createElement('div');
                    meteor.className = 'meteor';
                    meteor.style.left = Math.random() * 100 + '%';
                    meteor.style.top = '-50px';
                    meteor.style.animation = 'meteorFall 2s linear forwards';
                    meteor.style.background = colors[Math.floor(Math.random() * colors.length)];
                    
                    const length = Math.random() * 80 + 40;
                    meteor.style.setProperty('--tail-length', length + 'px');
                    meteor.style.transform = `rotate(${Math.random() * 20 + 40}deg)`;
                    
                    document.body.appendChild(meteor);
                    
                    setTimeout(() => meteor.remove(), 2000);
                }, i * 150);
            }
        }

        function showResultBanner(text, nextStep) {
            const banner = document.createElement('div');
            banner.className = 'result-banner';
            banner.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 20px;">
                    <span>${text}</span>
                    <button class="btn btn-primary" onclick="this.closest('.result-banner').remove(); ${nextStep}">Ø§Ù„ØªØ§Ù„ÙŠ â†’</button>
                </div>
            `;
            document.body.appendChild(banner);
            
            setTimeout(() => {
                banner.style.top = '20px';
            }, 100);
            
            createMeteorShower();
            setTimeout(() => createMeteorShower(), 500);
            
            setTimeout(() => {
                if (banner.parentNode) {
                    banner.remove();
                }
            }, 10000);
        }

        // ğŸ§­ Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†Ù‚Ù„
        function navigateTo(page) {
            appData.pageHistory.push(appData.currentPage);
            appData.currentPage = page;
            render();
        }

        function goBack() {
            if (appData.pageHistory.length > 0) {
                appData.currentPage = appData.pageHistory.pop();
                render();
            }
        }

        function logout() {
            const music = document.getElementById('background-music');
            if (music && !music.paused) {
                music.pause();
                music.currentTime = 0;
            }
            appData.musicEnabled = false;
            localStorage.setItem('MahercoMusicEnabled', 'false');
            
            appData.currentUser = null;
            appData.currentPage = 'login';
            appData.pageHistory = [];
            localStorage.removeItem('MahercoCurrentUser');
            render();
        }

        // ğŸ¨ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø±Ø¶ (ÙƒÙ…Ø§ Ù‡ÙŠ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ)
        function renderLogin() {
            return `
                <div class="login-container">
                    <div class="login-box">
                        <h1 class="title text-center mb-4">${appData.siteName || 'Maherco.Challenges'}</h1>
                        <input type="text" id="username" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                        <input type="password" id="password" class="input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                        <button class="btn btn-primary" style="width: 100%;" onclick="handleLogin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                        ${appData.firebaseError ? `
                            <div style="color: #EF4444; margin-top: 15px; text-align: center;">
                                âš ï¸ ${appData.firebaseError}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        async function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const user = appData.users.find(u => u.username === username && u.password === password);
            
            if (user) {
                appData.currentUser = user;
                appData.currentPage = 'home';
                saveUserSession();
                render();
            } else {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
            }
        }

        function renderHome() {
            if (!appData.firebaseLoaded) {
                return `
                    <div class="container">
                        <div class="text-center" style="margin-top: 100px;">
                            <div class="spinner"></div>
                            <p style="color: #FFD700; font-size: 1.5rem; margin-top: 20px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
                        </div>
                    </div>
                `;
            }

            const isAdmin = appData.currentUser.type === 'admin';
            const menuItems = [
                { icon: 'ğŸ¡', label: 'Ø¯ÙˆÙ„Ø§Ø¨ Ø§Ù„Ø­Ø¸', page: 'wheel', allowed: ['admin'] },
                { icon: 'ğŸ¯', label: 'Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©', page: 'current', allowed: ['admin', 'player', 'guest'] },
                { icon: 'ğŸ“•', label: 'Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©', page: 'saved', allowed: ['admin', 'player'] },
                { icon: 'ğŸ†', label: 'ØªØ±ØªÙŠØ¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†', page: 'ranking', allowed: ['admin', 'player', 'guest'] },
                { icon: 'âš™ï¸', label: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', page: 'settings', allowed: ['admin'] },
                { icon: 'ğŸ“', label: 'Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª', page: 'notes', allowed: ['admin', 'player'] }
            ];

            const filteredItems = menuItems.filter(item => item.allowed.includes(appData.currentUser.type));

            return `
                <div class="container">
                    <div class="header">
                        <h1 class="title">${appData.siteName || 'Maherco.Challenges'}</h1>
                        <button class="btn btn-logout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                    </div>
                    <div class="menu-grid">
                        ${filteredItems.map(item => `
                            <button class="menu-item" onclick="navigateTo('${item.page}')">
                                <div style="font-size: 3rem;">${item.icon}</div>
                                <span>${item.label}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderWheel() {
            const hasIncompleteChallenges = appData.currentChallenges.length > 0;
            
            let missingItems = [];
            if (appData.games.length === 0) missingItems.push('Ø£Ù„Ø¹Ø§Ø¨');
            if (appData.players.length === 0) missingItems.push('Ù„Ø§Ø¹Ø¨ÙŠÙ†');
            if (appData.cards.length === 0) missingItems.push('Ø¨Ø·Ø§Ù‚Ø§Øª');
            
            if (missingItems.length > 0 && !hasIncompleteChallenges) {
                return `
                    <div class="container">
                        <div class="header">
                            <button class="btn btn-back" onclick="goBack()">â† Ø±Ø¬ÙˆØ¹</button>
                            <h2 class="title">Ø¯ÙˆÙ„Ø§Ø¨ Ø§Ù„Ø­Ø¸ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ</h2>
                            <div></div>
                        </div>
                        <div class="warning-message">
                            <h3 style="color: #EF4444; margin-bottom: 15px;">âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¨Ø¯Ø¡ ØªØ­Ø¯ÙŠ Ø¬Ø¯ÙŠØ¯</h3>
                            <p style="font-size: 1.2rem;">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© ${missingItems.join(' Ùˆ')} Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.</p>
                            <button class="btn btn-info" onclick="navigateTo('settings')" style="margin-top: 15px;">
                                Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                            </button>
                        </div>
                    </div>
                `;
            }

            let items = [];
            if (appData.wheelStep === 'games') items = appData.games;
            else if (appData.wheelStep === 'players') items = appData.availablePlayers.map(p => p.name);
            else if (appData.wheelStep === 'cards') items = appData.availableCards;

            const colors = ['#EF4444', '#3B82F6', '#EAB308', '#22C55E'];
            const segmentAngle = 360 / Math.max(items.length, 1);

            let svg = `<svg viewBox="0 0 200 200" id="wheel">`;
            
            if (items.length === 1) {
                svg += `
                    <circle cx="100" cy="100" r="100" fill="#3B82F6" stroke="#000" stroke-width="2"/>
                    <text x="180" y="105" fill="white" font-size="12" font-weight="bold" text-anchor="end" dominant-baseline="middle">
                        ${items[0] || 'â€”'}
                    </text>
                `;
            } else if (items.length > 0) {
                items.forEach((item, index) => {
                    const startAngle = index * segmentAngle - 90;
                    const endAngle = startAngle + segmentAngle;
                    const largeArcFlag = segmentAngle > 180 ? 1 : 0;
                    
                    const x1 = 100 + 100 * Math.cos(startAngle * Math.PI / 180);
                    const y1 = 100 + 100 * Math.sin(startAngle * Math.PI / 180);
                    const x2 = 100 + 100 * Math.cos(endAngle * Math.PI / 180);
                    const y2 = 100 + 100 * Math.sin(endAngle * Math.PI / 180);
                    
                    const textAngle = startAngle + segmentAngle / 2;
                    const textX = 100 + 60 * Math.cos(textAngle * Math.PI / 180);
                    const textY = 100 + 60 * Math.sin(textAngle * Math.PI / 180);
                    
                    svg += `
                        <path d="M 100 100 L ${x1} ${y1} A 100 100 0 ${largeArcFlag} 1 ${x2} ${y2} Z"
                              fill="${colors[index % colors.length]}"
                              stroke="#000"
                              stroke-width="2"/>
                        <text x="${textX}" y="${textY}"
                              fill="white"
                              font-size="10"
                              font-weight="bold"
                              text-anchor="middle"
                              dominant-baseline="middle"
                              transform="rotate(${textAngle + 90}, ${textX}, ${textY})">
                            ${item}
                        </text>
                    `;
                });
            }
            
            svg += `<circle cx="100" cy="100" r="20" fill="white"/></svg>`;

            let stepText = '';
            if (appData.wheelStep === 'games') stepText = 'Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„Ø¹Ø¨Ø©';
            else if (appData.wheelStep === 'players') stepText = `Ø§Ù„Ù„Ø¹Ø¨Ø©: ${appData.selectedGame} - Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨`;
            else if (appData.wheelStep === 'cards') stepText = `Ø§Ù„Ù„Ø§Ø¹Ø¨: ${appData.currentChallenge?.currentPlayer?.name} - Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©`;

            let currentPlayers = '';
            if (appData.currentChallenge && appData.currentChallenge.players && appData.currentChallenge.players.length > 0) {
                currentPlayers = `
                    <div class="card mt-4" style="max-width: 600px; margin: 0 auto;">
                        <h3 class="card-title">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙˆÙ†:</h3>
                        ${appData.currentChallenge.players.map(p => `
                            <div class="list-item">
                                <span>${p.player.name}</span>
                                <span style="color: #FFD700;">${p.card}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            const hasActiveChallenge = appData.currentChallenges.length > 0;
            const isChallengeInProgress = appData.currentChallenge !== null;
            
            let wheelMessage = '';
            let wheelDisabled = false;
            
            if (hasActiveChallenge) {
                wheelMessage = '<div class="challenge-warning">âš ï¸ Ø£Ù†Ù‡Ù Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„ÙƒÙŠ ØªØ³ØªØ·ÙŠØ¹ Ø¨Ø¯Ø¡ ØªØ­Ø¯ÙŠ Ø¬Ø¯ÙŠØ¯</div>';
                wheelDisabled = true;
            } else if (!isChallengeInProgress) {
                wheelMessage = '<div class="start-challenge-text" onclick="startNewChallenge()">ğŸ¯ Ø¨Ø¯Ø¡ ØªØ­Ø¯ÙŠ</div>';
            }

            return `
                <div class="container">
                    <div class="header">
                        <button class="btn btn-back" onclick="goBack()">â† Ø±Ø¬ÙˆØ¹</button>
                        <h2 class="title">Ø¯ÙˆÙ„Ø§Ø¨ Ø§Ù„Ø­Ø¸ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ</h2>
                        <div></div>
                    </div>
                    <div class="wheel-container">
                        ${wheelMessage}
                        <p class="wheel-info">${stepText}</p>
                        ${!wheelDisabled ? '<p style="color: #FCD34D; font-size: 1.2rem;">Ø§Ù†Ù‚Ø± Ù„ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø¹Ø¬Ù„Ø©</p>' : ''}
                        <div class="wheel-wrapper">
                            <div class="wheel-pointer"></div>
                            ${svg}
                        </div>
                        ${currentPlayers}
                    </div>
                </div>
            `;
        }

        function startNewChallenge() {
            appData.wheelStep = 'games';
            appData.selectedGame = null;
            appData.currentChallenge = null;
            appData.availablePlayers = [...appData.players];
            appData.availableCards = [...appData.cards];
            appData.rotation = 0;
            render();
        }

        function spinWheel() {
            if (appData.isSpinning || appData.currentChallenges.length > 0) {
                return;
            }
            
            playWheelSound();
            
            appData.isSpinning = true;
            const spins = 5 + Math.random() * 5;
            appData.rotation += 360 * spins + Math.random() * 360;
            
            const wheel = document.getElementById('wheel');
            if (wheel) {
                wheel.style.transform = `rotate(${appData.rotation}deg)`;
            }
            
            setTimeout(() => {
                appData.isSpinning = false;
                handleWheelResult();
            }, 6000);
        }

        function handleWheelResult() {
            const normalizedRotation = appData.rotation % 360;
            
            if (appData.wheelStep === 'games') {
                const segmentAngle = 360 / appData.games.length;
                const selectedIndex = Math.floor((360 - normalizedRotation) / segmentAngle) % appData.games.length;
                const game = appData.games[selectedIndex];
                
                appData.selectedGame = game;
                appData.games = appData.games.filter(g => g !== game);
                appData.currentChallenge = {
                    game: game,
                    players: [],
                    createdAt: new Date().toISOString()
                };
                appData.wheelStep = 'players';
                appData.rotation = 0;
                
                showResultBanner(`ğŸ® ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„Ø¹Ø¨Ø©: ${game}`, "appData.rotation = 0; render();");
                
            } else if (appData.wheelStep === 'players') {
                if (appData.availablePlayers.length === 0) {
                    const challenge = {
                        ...appData.currentChallenge,
                        id: Date.now(),
                        status: 'current'
                    };
                    appData.currentChallenges.push(challenge);
                    startNewChallenge();
                    return;
                }
                
                const segmentAngle = 360 / appData.availablePlayers.length;
                const selectedIndex = Math.floor((360 - normalizedRotation) / segmentAngle) % appData.availablePlayers.length;
                const player = appData.availablePlayers[selectedIndex];
                
                appData.availablePlayers = appData.availablePlayers.filter(p => p.id !== player.id);
                appData.currentChallenge.currentPlayer = player;
                appData.wheelStep = 'cards';
                appData.rotation = 0;
                
                showResultBanner(`ğŸ‘¤ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨: ${player.name}`, "appData.rotation = 0; render();");
                
            } else if (appData.wheelStep === 'cards') {
                const segmentAngle = 360 / appData.availableCards.length;
                const selectedIndex = Math.floor((360 - normalizedRotation) / segmentAngle) % appData.availableCards.length;
                const card = appData.availableCards[selectedIndex];
                
                appData.currentChallenge.players = appData.currentChallenge.players || [];
                appData.currentChallenge.players.push({
                    player: appData.currentChallenge.currentPlayer,
                    card: card,
                    points: 0
                });
                
                appData.availableCards = appData.availableCards.filter(c => c !== card);
                
                if (appData.availablePlayers.length === 0) {
                    const challenge = {
                        ...appData.currentChallenge,
                        id: Date.now(),
                        status: 'current'
                    };
                    appData.currentChallenges.push(challenge);
                    
                    saveDataToFirebase();
                    showResultBanner(`ğŸ¯ Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ! ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ${appData.currentChallenge.players.length} Ù„Ø§Ø¹Ø¨ÙŠÙ†`, "startNewChallenge();");
                } else {
                    appData.wheelStep = 'players';
                    appData.rotation = 0;
                    
                    showResultBanner(`ğŸƒ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ${card}`, "appData.rotation = 0; render();");
                }
            }
            
            // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¥Ù„Ù‰ Firebase
            saveDataToFirebase();
        }

        function renderCurrentChallenges() {
            return `
                <div class="container">
                    <div class="header">
                        <button class="btn btn-back" onclick="goBack()">â† Ø±Ø¬ÙˆØ¹</button>
                        <h2 class="title">Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>
                        <div></div>
                    </div>
                    ${appData.currentChallenges.length === 0 ? 
                        '<p class="text-center text-gray" style="font-size: 1.5rem; margin-top: 50px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ§Øª Ø­Ø§Ù„ÙŠØ©</p>' :
                        appData.currentChallenges.map((challenge, idx) => `
                            <div class="card">
                                <h3 class="card-title">${challenge.game}</h3>
                                <p class="text-sm text-gray mb-4">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date(challenge.createdAt).toLocaleString('ar-EG')}</p>
                                ${challenge.players.map(p => `
                                    <div class="list-item">
                                        <span>${p.player.name}</span>
                                        <span style="color: #FFD700;">${p.card}</span>
                                    </div>
                                `).join('')}
                                ${appData.currentUser.type === 'admin' ? `
                                    <div class="btn-group mt-4">
                                        <button class="btn btn-success" onclick="finishChallenge(${idx})">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ</button>
                                        <button class="btn btn-danger" onclick="deleteCurrentChallenge(${idx})">Ø­Ø°Ù Ø§Ù„ØªØ­Ø¯ÙŠ</button>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')
                    }
                </div>
            `;
        }

        async function finishChallenge(index) {
            const challenge = appData.currentChallenges[index];
            
            const panel = document.createElement('div');
            panel.className = 'points-input-panel';
            panel.innerHTML = `
                <h3>ğŸ”¢ Ø£Ø¯Ø®Ù„ Ù†Ù‚Ø§Ø· Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h3>
                ${challenge.players.map((p, i) => `
                    <div class="points-input-item">
                        <span style="font-size: 1.2rem; font-weight: bold;">
                            ${p.player.name} - ${p.card}
                        </span>
                        <input type="number" id="points-${i}" placeholder="0" min="0" max="999">
                    </div>
                `).join('')}
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="confirmFinishChallenge(${index})">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†Ù‚Ø§Ø·</button>
                    <button class="btn btn-danger" onclick="cancelFinishChallenge()">âŒ Ø¥Ù„ØºØ§Ø¡</button>
                </div>
`; 
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <button class="btn btn-back" onclick="goBack()">â† Ø±Ø¬ÙˆØ¹</button>
                        <h2 class="title">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ: ${challenge.game}</h2>
                        <div></div>
                    </div>
                    ${panel.outerHTML}
                </div>
            `;
        }

        async function confirmFinishChallenge(index) {
            const challenge = appData.currentChallenges[index];
            const pointsData = {};
            
            challenge.players.forEach((p, i) => {
                const input = document.getElementById(`points-${i}`);
                const points = parseInt(input.value) || 0;
                pointsData[p.player.id] = points;
            });
            
            const updatedChallenge = {
                ...challenge,
                id: Date.now(),
                status: 'saved',
                completedAt: new Date().toISOString(),
                players: challenge.players.map(p => ({
                    ...p,
                    points: pointsData[p.player.id] || 0
                }))
            };
            
            appData.players = appData.players.map(player => {
                const challengePlayer = updatedChallenge.players.find(p => p.player.id === player.id);
                if (challengePlayer) {
                    const historyEntry = {
                        challengeId: updatedChallenge.id,
                        game: updatedChallenge.game,
                        card: challengePlayer.card,
                        points: challengePlayer.points,
                        date: updatedChallenge.completedAt
                    };
                    
                    return {
                        ...player,
                        points: player.points + challengePlayer.points,
                        challenges: player.challenges + 1,
                        cards: player.cards + 1,
                        challengeHistory: [...(player.challengeHistory || []), historyEntry]
                    };
                }
                return player;
            });
            
            appData.savedChallenges.push(updatedChallenge);
            appData.currentChallenges.splice(index, 1);
            
            // Ø­ÙØ¸ Ø¥Ù„Ù‰ Firebase
            await saveDataToFirebase();
            goBack();
        }

        function cancelFinishChallenge() {
            render();
        }

        async function deleteCurrentChallenge(index) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ø¯ÙŠØŸ')) {
                appData.currentChallenges.splice(index, 1);
                await saveDataToFirebase();
                render();
            }
        }

        function renderSavedChallenges() {
            return `
                <div class="container">
                    <div class="header">
                        <button class="btn btn-back" onclick="goBack()">â† Ø±Ø¬ÙˆØ¹</button>
                        <h2 class="title">Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h2>
                        <div></div>
                    </div>
                    ${appData.savedChallenges.length === 0 ?
                        '<p class="text-center text-gray" style="font-size: 1.5rem; margin-top: 50px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ§Øª Ù…Ø­ÙÙˆØ¸Ø©</p>' :
                        appData.savedChallenges.map((challenge, idx) => `
                            <div class="card" style="border-color: #10B981;">
                                <h3 class="card-title">${challenge.game}</h3>
                                <p class="text-sm text-gray mb-4">ØªÙ… Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡: ${new Date(challenge.completedAt).toLocaleString('ar-EG')}</p>
                                ${challenge.players.map(p => `
                                    <div class="list-item">
                                        <span>${p.player.name}</span>
                                        <span style="color: #FFD700;">${p.card}</span>
                                        <span style="color: #10B981; font-weight: bold;">${p.points} Ù†Ù‚Ø·Ø©</span>
                                    </div>
                                `).join('')}
                                ${appData.currentUser.type === 'admin' ? `
                                    <button class="btn btn-danger mt-4" style="width: 100%;" onclick="deleteSavedChallenge(${idx})">
                                        Ø­Ø°Ù Ø§Ù„ØªØ­Ø¯ÙŠ
                                    </button>
                                ` : ''}
                            </div>
                        `).join('')
                    }
                </div>
            `;
        }

        async function deleteSavedChallenge(index) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ø¯ÙŠØŸ Ø³ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†.')) {
                const challenge = appData.savedChallenges[index];
                
                appData.players = appData.players.map(player => {
                    const challengePlayer = challenge.players.find(p => p.player.id === player.id);
                    if (challengePlayer) {
                        const updatedHistory = (player.challengeHistory || []).filter(
                            h => h.challengeId !== challenge.id
                        );
                        
                        return {
                            ...player,
                            points: Math.max(0, player.points - challengePlayer.points),
                            challenges: Math.max(0, player.challenges - 1),
                            cards: Math.max(0, player.cards - 1),
                            challengeHistory: updatedHistory
                        };
                    }
                    return player;
                });
                
                appData.savedChallenges.splice(index, 1);
                await saveDataToFirebase();
                render();
            }
        }

        function renderRanking() {
            const sortedPlayers = [...appData.players].sort((a, b) => b.points - a.points);
            
            return `
                <div class="container">
                    <div class="header">
                        <button class="btn btn-back" onclick="goBack()">â† Ø±Ø¬ÙˆØ¹</button>
                        <h2 class="title">ØªØ±ØªÙŠØ¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h2>
                        <div></div>
                    </div>
                    ${appData.currentUser.type === 'admin' ? `
                        <button class="btn btn-info mb-4" onclick="navigateTo('adjust-points')">
                            Ø®ØµÙ…/Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø·
                        </button>
                    ` : ''}
                    ${sortedPlayers.map((player, index) => `
                        <div class="list-item" style="cursor: pointer; padding: 20px;" onclick="viewPlayerDetails(${player.id})">
                            <div class="flex items-center gap-4">
                                <span class="player-rank rank-${index + 1}">${index + 1}</span>
                                <div>
                                    <div style="font-size: 1.5rem; font-weight: bold;">${player.name}</div>
                                    <div class="text-gray">Ø§Ù„Ù†Ù‚Ø§Ø·: ${player.points}</div>
                                </div>
                            </div>
                            ${index === 0 ? '<span style="font-size: 3rem;">ğŸ†</span>' : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function viewPlayerDetails(playerId) {
            appData.selectedPlayer = appData.players.find(p => p.id === playerId);
            navigateTo('player-details');
        }

        function renderPlayerDetails() {
            const player = appData.selectedPlayer;
            
            return `
                <div class="container">
                    <div class="header">
                        <button class="btn btn-back" onclick="goBack()">â† Ø±Ø¬ÙˆØ¹</button>
                        <h2 class="title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨</h2>
                        <div></div>
                    </div>
                    <div class="card" style="max-width: 600px; margin: 0 auto;">
                        <h3 class="card-title text-center" style="font-size: 2rem;">${player.name}</h3>
                        <div class="list-item mb-4">
                            <span style="font-weight: bold;">Ø§Ù„Ù†Ù‚Ø§Ø·:</span>
                            <span style="color: #FFD700; font-size: 1.5rem; font-weight: bold;">${player.points}</span>
                        </div>
                        <div class="list-item mb-4">
                            <span style="font-weight: bold;">Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª:</span>
                            <span style="color: #10B981; font-size: 1.5rem; font-weight: bold;">${player.challenges}</span>
                        </div>
                        <div class="list-item mb-4">
                            <span style="font-weight: bold;">Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª:</span>
                            <span style="color: #3B82F6; font-size: 1.5rem; font-weight: bold;">${player.cards}</span>
                        </div>
                        
                        ${(player.challengeHistory && player.challengeHistory.length > 0) ? `
                            <div class="player-challenges-list">
                                <h4 style="color: #FFD700; margin-bottom: 10px;">ğŸ“œ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª:</h4>
                                ${player.challengeHistory.slice().reverse().map(h => `
                                    <div class="challenge-item">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span style="font-weight: bold;">${h.game}</span>
                                            <span style="color: #FFD700;">${h.card}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                            <span class="text-sm text-gray">${new Date(h.date).toLocaleDateString('ar-EG')}</span>
                                            <span style="color: #10B981; font-weight: bold;">${h.points} Ù†Ù‚Ø·Ø©</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${player.instagram ? `
                            <a href="${player.instagram}" target="_blank" class="btn" 
                               style="width: 100%; margin-top: 15px; background: linear-gradient(135deg, #833AB4, #FD1D1D, #FCB045); text-decoration: none; color: white; display: block; text-align: center;">
                                Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ù†Ø³ØªØºØ±Ø§Ù…
                            </a>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderAdjustPoints() {
            return `
                <div class="container">
                    <div class="header">
                        <button class="btn btn-back" onclick="goBack()">â† Ø±Ø¬ÙˆØ¹</button>
                        <h2 class="title">Ø®ØµÙ…/Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø·</h2>
                        <div></div>
                    </div>
                    <div class="card" style="max-width: 600px; margin: 0 auto;">
                        <div class="form-group">
                            <label>Ø§Ø®ØªØ± Ø§Ù„Ù„Ø§Ø¹Ø¨:</label>
                            <select id="adjustPlayerId">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù„Ø§Ø¹Ø¨</option>
                                ${appData.players.map(p => `
                                    <option value="${p.id}">${p.name} - ${p.points} Ù†Ù‚Ø·Ø©</option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø·:</label>
                            <input type="number" id="addPoints" class="input" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>Ø®ØµÙ… Ù†Ù‚Ø§Ø·:</label>
                            <input type="number" id="subtractPoints" class="input" placeholder="0">
                        </div>
                        <button class="btn btn-primary" style="width: 100%;" onclick="applyPointsAdjustment()">
                            ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                        </button>
                    </div>
                </div>
            `;
        }

        async function applyPointsAdjustment() {
            const playerId = parseInt(document.getElementById('adjustPlayerId').value);
            const addPoints = parseInt(document.getElementById('addPoints').value) || 0;
            const subtractPoints = parseInt(document.getElementById('subtractPoints').value) || 0;
            
            if (!playerId) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù„Ø§Ø¹Ø¨');
                return;
            }
            
            appData.players = appData.players.map(p => {
                if (p.id === playerId) {
                    let newPoints = p.points + addPoints - subtractPoints;
                    return { ...p, points: Math.max(0, newPoints) };
                }
                return p;
            });
            
            await saveDataToFirebase();
            alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø· Ø¨Ù†Ø¬Ø§Ø­');
            goBack();
        }

        function renderSettings() {
            const settingsMenu = [
                { label: 'Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ ğŸ®', page: 'manage-games' },
                { label: 'Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ğŸ‘¤', page: 'manage-players' },
                { label: 'Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ğŸƒ', page: 'manage-cards' },
                { label: 'ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ ğŸ’³', page: 'change-site-name' },
                { label: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª ğŸ”Š', page: 'sound-settings' },
                { label: 'ØªØµÙÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ğŸ—ƒ', page: 'reset-all' },
                { label: 'ØªØµÙÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø· Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ â­', page: 'reset-points' },
                { label: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ğŸªª', page: 'manage-accounts' }
            ];
            
            return `
                <div class="container">
                    <div class="header">
                        <button class="btn btn-back" onclick="goBack()">â† Ø±Ø¬ÙˆØ¹</button>
                        <h2 class="title">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
                        <div></div>
                    </div>
                    <div class="settings-grid" style="max-width: 700px; margin: 0 auto;">
                        ${settingsMenu.map(item => `
                            <button class="settings-btn" onclick="navigateTo('${item.page}')">
                                ${item.label}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderSoundSettings() {
            return `
                <div class="container">
                    <div class="header">
                        <button class="btn btn-back" onclick="goBack()">â† Ø±Ø¬ÙˆØ¹</button>
                        <h2 class="title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª</h2>
                        <div></div>
                    </div>
                    
                    <div class="card" style="max-width: 600px; margin: 0 auto 20px;">
                        <h3 class="card-title text-center">ğŸ”Š ØµÙˆØª Ø§Ù„Ø¯ÙˆÙ„Ø§Ø¨ </h3>
                        <div style="display: flex; justify-content: center; gap: 20px; margin: 30px 0;">
                            <button class="btn ${appData.soundEnabled ? 'btn-success' : 'btn-disabled'}" 
                                    style="padding: 20px 40px; font-size: 1.2rem;" 
                                    onclick="toggleSound(true)">
                                âœ… ØªØ´ØºÙŠÙ„
                            </button>
                            <button class="btn ${!appData.soundEnabled ? 'btn-danger' : 'btn-disabled'}" 
                                    style="padding: 20px 40px; font-size: 1.2rem;" 
                                    onclick="toggleSound(false)">
                                âŒ Ø¥ÙŠÙ‚Ø§Ù
                            </button>
                        </div>
                        <p class="text-center text-sm text-gray">
                            Ø­Ø§Ù„Ø© ØµÙˆØª Ø§Ù„Ø¯ÙˆÙ„Ø§Ø¨: <span style="color: ${appData.soundEnabled ? '#10B981' : '#EF4444'}; font-weight: bold;">
                                ${appData.soundEnabled ? 'Ù…ÙØ¹Ù‘Ù„' : 'Ù…Ø¹Ø·Ù‘Ù„'}
                            </span>
                        </p>
                    </div>
                    
                    <div class="card" style="max-width: 600px; margin: 0 auto;">
                        <h3 class="card-title text-center">ğŸµ</h3>
                        <p class="text-center text-gray mb-4">Interstellar</p>
                        <div style="display: flex; justify-content: center; gap: 20px; margin: 30px 0;">
                            <button class="btn ${appData.musicEnabled ? 'btn-success' : 'btn-disabled'}" 
                                    style="padding: 20px 40px; font-size: 1.2rem;" 
                                    onclick="toggleMusic()">
                                ${appData.musicEnabled ? 'ğŸ”Š ØªØ´ØºÙŠÙ„' : 'ğŸ”‡ Ø¥ÙŠÙ‚Ø§Ù'}
                            </button>
                        </div>
                        <p class="text-center text-sm text-gray">
                            Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰: <span style="color: ${appData.musicEnabled ? '#10B981' : '#EF4444'}; font-weight: bold;">
                                ${appData.musicEnabled ? 'ØªØ¹Ù…Ù„' : 'Ù…ØªÙˆÙ‚ÙØ©'}
                            </span>
                            <br>
                            <small>Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„/Ø§Ù„Ø¥ÙŠÙ‚Ø§ÙØŒ ØªØ¹ÙˆØ¯ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©</small>
                        </p>
                    </div>
                </div>
            `;
        }

        // Ø¨Ø§Ù‚ÙŠ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø±Ø¶ (ÙƒÙ…Ø§ Ù‡ÙŠ)...
        function renderManageGames() {
            return `
                <div class="container">
                    <div class="header">
                        <button class="btn btn-back" onclick="goBack()">â† Ø±Ø¬ÙˆØ¹</button>
                        <h2 class="title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</h2>
                        <div></div>
                    </div>
                    <div style="max-width: 700px; margin: 0 auto;">
                        <div class="flex gap-4 mb-4">
                            <input type="text" id="newGame" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø©" style="flex: 1;">
                            <button class="btn btn-success" onclick="addGame()">Ø¥Ø¶Ø§ÙØ©</button>
                        </div>
                        ${appData.games.map((game, idx) => `
                            <div class="list-item">
                                <span>${game}</span>
                                <button class="btn btn-danger" style="padding: 8px 16px;" onclick="deleteGame(${idx})">Ø­Ø°Ù</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        async function addGame() {
            const input = document.getElementById('newGame');
            if (input.value.trim()) {
                appData.games.push(input.value.trim());
                await saveDataToFirebase();
                render();
            }
        }

        async function deleteGame(index) {
            appData.games.splice(index, 1);
            await saveDataToFirebase();
            render();
        }

        function renderManagePlayers() {
            return `
                <div class="container">
                    <div class="header">
                        <button class="btn btn-back" onclick="goBack()">â† Ø±Ø¬ÙˆØ¹</button>
                        <h2 class="title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h2>
                        <div></div>
                    </div>
                    <div style="max-width: 700px; margin: 0 auto;">
                        <div class="card mb-4">
                            <h3 class="card-title">Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
                            <input type="text" id="newPlayerName" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨">
                            <input type="text" id="newPlayerInstagram" class="input" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ù†Ø³ØªØºØ±Ø§Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                            <button class="btn btn-success" style="width: 100%;" onclick="addPlayer()">Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨</button>
                        </div>
                        ${appData.players.map((player, idx) => `
                            <div class="list-item">
                                <div>
                                    <div style="font-weight: bold;">${player.name}</div>
                                    <div class="text-sm text-gray">${player.points} Ù†Ù‚Ø·Ø©</div>
                                </div>
                                <button class="btn btn-danger" style="padding: 8px 16px;" onclick="deletePlayer(${idx})">Ø­Ø°Ù</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        async function addPlayer() {
            const name = document.getElementById('newPlayerName').value.trim();
            const instagram = document.getElementById('newPlayerInstagram').value.trim();
            
            if (name) {
                appData.players.push({
                    id: Date.now(),
                    name: name,
                    points: 0,
                    challenges: 0,
                    cards: 0,
                    instagram: instagram,
                    challengeHistory: []
                });
                await saveDataToFirebase();
                render();
            }
        }

        async function deletePlayer(index) {
            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${appData.players[index].name}ØŸ`)) {
                appData.players.splice(index, 1);
                await saveDataToFirebase();
                render();
            }
        }

        function renderManageCards() {
            return `
                <div class="container">
                    <div class="header">
                        <button class="btn btn-back" onclick="goBack()">â† Ø±Ø¬ÙˆØ¹</button>
                        <h2 class="title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</h2>
                        <div></div>
                    </div>
                    <div style="max-width: 700px; margin: 0 auto;">
                        <div class="flex gap-4 mb-4">
                            <input type="text" id="newCard" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©" style="flex: 1;">
                            <button class="btn btn-success" onclick="addCard()">Ø¥Ø¶Ø§ÙØ©</button>
                        </div>
                        ${appData.cards.map((card, idx) => `
                            <div class="list-item">
                                <span>${card}</span>
                                <button class="btn btn-danger" style="padding: 8px 16px;" onclick="deleteCard(${idx})">Ø­Ø°Ù</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        async function addCard() {
            const input = document.getElementById('newCard');
            if (input.value.trim()) {
                appData.cards.push(input.value.trim());
                await saveDataToFirebase();
                render();
            }
        }

        async function deleteCard(index) {
            appData.cards.splice(index, 1);
            await saveDataToFirebase();
            render();
        }

        function renderChangeSiteName() {
            return `
                <div class="container">
                    <div class="header">
                        <button class="btn btn-back" onclick="goBack()">â† Ø±Ø¬ÙˆØ¹</button>
                        <h2 class="title">ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>
                        <div></div>
                    </div>
                    <div class="card" style="max-width: 600px; margin: 0 auto;">
                        <input type="text" id="newSiteName" class="input" value="${appData.siteName}">
                        <button class="btn btn-success" style="width: 100%;" onclick="saveSiteName()">Ø­ÙØ¸</button>
                    </div>
                </div>
            `;
        }

        async function saveSiteName() {
            const newName = document.getElementById('newSiteName').value.trim();
            if (newName) {
                appData.siteName = newName;
                await saveDataToFirebase();
                goBack();
            }
        }

        function renderResetAll() {
            return `
                <div class="container">
                    <div class="header">
                        <button class="btn btn-back" onclick="goBack()">â† Ø±Ø¬ÙˆØ¹</button>
                        <h2 class="title">ØªØµÙÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>
                        <div></div>
                    </div>
                    <div class="card" style="max-width: 600px; margin: 0 auto; border-color: #EF4444;">
                        <p class="text-center" style="color: #EF4444; font-size: 1.3rem; font-weight: bold; margin-bottom: 20px;">
                            âš ï¸ ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ!
                        </p>
                        <button class="btn btn-danger" style="width: 100%;" onclick="resetAllData()">
                            ØªØµÙÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                        </button>
                    </div>
                </div>
            `;
        }

        async function resetAllData() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!')) {
                appData.games = [];
                appData.players = [{ id: 1, name: 'Player1', points: 0, challenges: 0, cards: 0, instagram: '', challengeHistory: [] }];
                appData.cards = [];
                appData.currentChallenges = [];
                appData.savedChallenges = [];
                appData.notes = [];
                appData.musicEnabled = false;
                
                const music = document.getElementById('background-music');
                if (music) {
                    music.pause();
                    music.currentTime = 0;
                }
                
                localStorage.removeItem('MahercoCurrentUser');
                localStorage.removeItem('MahercoMusicEnabled');
                
                await saveDataToFirebase();
                goBack();
            }
        }

        function renderResetPoints() {
            return `
                <div class="container">
                    <div class="header">
                        <button class="btn btn-back" onclick="goBack()">â† Ø±Ø¬ÙˆØ¹</button>
                        <h2 class="title">ØªØµÙÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø·</h2>
                        <div></div>
                    </div>
                    <div class="card" style="max-width: 600px; margin: 0 auto; border-color: #EF4444;">
                        <p class="text-center" style="color: #EF4444; font-size: 1.3rem; font-weight: bold; margin-bottom: 20px;">
                            âš ï¸ Ø³ÙŠØªÙ… ØªØµÙÙŠØ± Ù†Ù‚Ø§Ø· Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†!
                        </p>
                        <button class="btn btn-danger" style="width: 100%;" onclick="resetPoints()">
                            ØªØµÙÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø·
                        </button>
                    </div>
                </div>
            `;
        }

        async function resetPoints() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù‚Ø§Ø·ØŸ')) {
                appData.players = appData.players.map(p => ({
                    ...p,
                    points: 0,
                    challenges: 0,
                    cards: 0,
                    challengeHistory: []
                }));
                await saveDataToFirebase();
                goBack();
            }
        }

        function renderManageAccounts() {
            return `
                <div class="container">
                    <div class="header">
                        <button class="btn btn-back" onclick="goBack()">â† Ø±Ø¬ÙˆØ¹</button>
                        <h2 class="title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h2>
                        <div></div>
                    </div>
                    <div style="max-width: 700px; margin: 0 auto;">
                        <div class="card mb-4">
                            <h3 class="card-title">Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
                            <input type="text" id="newUsername" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                            <input type="password" id="newPassword" class="input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                            <select id="newUserType" class="input">
                                <option value="admin">Ù…Ø¯ÙŠØ± (Admin)</option>
                                <option value="player">Ù„Ø§Ø¹Ø¨ (Player)</option>
                                <option value="guest">Ø¶ÙŠÙ (Guest)</option>
                            </select>
                            <button class="btn btn-success" style="width: 100%;" onclick="addUser()">Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨</button>
                        </div>
                        ${appData.users.map((user, idx) => `
                            <div class="card">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <div style="font-weight: bold; font-size: 1.2rem;">${user.username}</div>
                                        <div class="text-sm text-gray">
                                            Ø§Ù„Ù†ÙˆØ¹: ${user.type === 'admin' ? 'Ù…Ø¯ÙŠØ±' : user.type === 'player' ? 'Ù„Ø§Ø¹Ø¨' : 'Ø¶ÙŠÙ'}
                                        </div>
                                        <div class="text-sm text-gray">
                                            ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date(user.createdAt).toLocaleString('ar-EG')}
                                        </div>
                                    </div>
                                    ${user.username !== 'admin' ? `
                                        <button class="btn btn-danger" onclick="deleteUser(${idx})">Ø­Ø°Ù</button>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        async function addUser() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value.trim();
            const type = document.getElementById('newUserType').value;
            
            if (username && password) {
                appData.users.push({
                    id: Date.now(),
                    username: username,
                    password: password,
                    type: type,
                    createdAt: new Date().toISOString()
                });
                await saveDataToFirebase();
                render();
            }
        }

        async function deleteUser(index) {
            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø­Ø³Ø§Ø¨ ${appData.users[index].username}ØŸ`)) {
                appData.users.splice(index, 1);
                await saveDataToFirebase();
                render();
            }
        }

        function renderNotes() {
            return `
                <div class="container">
                    <div class="header">
                        <button class="btn btn-back" onclick="goBack()">â† Ø±Ø¬ÙˆØ¹</button>
                        <h2 class="title">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h2>
                        <div></div>
                    </div>
                    <div style="max-width: 800px; margin: 0 auto;">
                        ${appData.currentUser.type === 'admin' ? `
                            <div class="card mb-4">
                                <h3 class="card-title">Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                                <input type="text" id="noteTitle" class="input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù„Ø­Ø¸Ø©">
                                <textarea id="noteContent" class="input" placeholder="Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ø­Ø¸Ø©"></textarea>
                                <button class="btn btn-success" style="width: 100%;" onclick="addNote()">Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø­Ø¸Ø©</button>
                            </div>
                        ` : ''}
                        ${appData.notes.length === 0 ? 
                            '<p class="text-center text-gray" style="font-size: 1.5rem; margin-top: 50px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</p>' :
                            appData.notes.map((note, idx) => `
                                <div class="card">
                                    <h3 class="card-title">${note.title}</h3>
                                    <p style="color: #D1D5DB; white-space: pre-wrap; margin-bottom: 15px;">${note.content}</p>
                                    <div class="flex justify-between items-center">
                                        <p class="text-sm text-gray">
                                            ${new Date(note.updatedAt || note.createdAt).toLocaleString('ar-EG')}
                                        </p>
                                        ${appData.currentUser.type === 'admin' ? `
                                            <div class="flex gap-4">
                                                <button class="btn btn-info" style="padding: 8px 16px;" onclick="editNote(${idx})">ØªØ¹Ø¯ÙŠÙ„</button>
                                                <button class="btn btn-danger" style="padding: 8px 16px;" onclick="deleteNote(${idx})">Ø­Ø°Ù</button>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
            `;
        }

        async function addNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();
            
            if (title && content) {
                appData.notes.push({
                    id: Date.now(),
                    title: title,
                    content: content,
                    createdAt: new Date().toISOString()
                });
                await saveDataToFirebase();
                render();
            }
        }

        async function editNote(index) {
            const note = appData.notes[index];
            const newTitle = prompt('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù„Ø­Ø¸Ø©:', note.title);
            if (newTitle) {
                const newContent = prompt('Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ø­Ø¸Ø©:', note.content);
                if (newContent) {
                    appData.notes[index] = {
                        ...note,
                        title: newTitle,
                        content: newContent,
                        updatedAt: new Date().toISOString()
                    };
                    await saveDataToFirebase();
                    render();
                }
            }
        }

        async function deleteNote(index) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©ØŸ')) {
                appData.notes.splice(index, 1);
                await saveDataToFirebase();
                render();
            }
        }

        // ğŸ¨ Ø§Ù„Ø±Ù†Ø¯Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        function render() {
            const app = document.getElementById('app');
            let content = '';
            
            switch(appData.currentPage) {
                case 'login':
                    content = renderLogin();
                    break;
                case 'home':
                    content = renderHome();
                    break;
                case 'wheel':
                    content = renderWheel();
                    break;
                case 'current':
                    content = renderCurrentChallenges();
                    break;
                case 'saved':
                    content = renderSavedChallenges();
                    break;
                case 'ranking':
                    content = renderRanking();
                    break;
                case 'player-details':
                    content = renderPlayerDetails();
                    break;
                case 'adjust-points':
                    content = renderAdjustPoints();
                    break;
                case 'settings':
                    content = renderSettings();
                    break;
                case 'manage-games':
                    content = renderManageGames();
                    break;
                case 'manage-players':
                    content = renderManagePlayers();
                    break;
                case 'manage-cards':
                    content = renderManageCards();
                    break;
                case 'change-site-name':
                    content = renderChangeSiteName();
                    break;
                case 'sound-settings':
                    content = renderSoundSettings();
                    break;
                case 'reset-all':
                    content = renderResetAll();
                    break;
                case 'reset-points':
                    content = renderResetPoints();
                    break;
                case 'manage-accounts':
                    content = renderManageAccounts();
                    break;
                case 'notes':
                    content = renderNotes();
                    break;
                default:
                    content = renderLogin();
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¥Ù†Ø³ØªØºØ±Ø§Ù…
            const instagramFooter = `
                <div class="footer-instagram" onclick="window.open('https://www.instagram.com/011sally?igsh=NTZqOGs0eGU5YXg2', '_blank')">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="2" y="2" width="20" height="20" rx="5" fill="white"/>
                        <circle cx="12" cy="12" r="4" fill="url(#instagram-gradient)"/>
                        <circle cx="18" cy="6" r="1.5" fill="white"/>
                        <defs>
                            <linearGradient id="instagram-gradient" x1="2" y1="22" x2="22" y2="2" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#833AB4"/>
                                <stop offset="0.5" stop-color="#FD1D1D"/>
                                <stop offset="1" stop-color="#FCB045"/>
                            </linearGradient>
                        </defs>
                    </svg>
                    <span>Sally</span>
                </div>
            `;
            
            app.innerHTML = content + instagramFooter;
            
            // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙˆØª
            if (!document.getElementById('wheel-audio')) {
                document.body.appendChild(audioElement);
            }
            if (!document.getElementById('background-music')) {
                document.body.appendChild(musicElement);
            }
            
            // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            if (appData.currentUser && appData.musicEnabled) {
                const music = document.getElementById('background-music');
                if (music && music.paused) {
                    music.play().catch(e => console.log('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹:', e));
                }
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ù„Ù„Ø¹Ø¬Ù„Ø©
            if (appData.currentPage === 'wheel') {
                setTimeout(() => {
                    const wheel = document.getElementById('wheel');
                    if (wheel && appData.currentChallenges.length === 0) {
                        wheel.addEventListener('click', spinWheel);
                    }
                }, 100);
            }
        }

        // ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        try {
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase
            loadDataFromFirebase();
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø¨ØµØ±ÙŠØ©
            createSparkles();
            
            // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„
            if (!appData.firebaseLoaded) {
                setTimeout(() => {
                    if (!appData.firebaseLoaded) {
                        console.warn('Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase...');
                        loadDataFromFirebase();
                    }
                }, 5000);
            }
        } catch (e) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', e);
            document.getElementById('app').innerHTML = `
                <div style="color: red; padding: 20px; text-align: center;">
                    <h2>âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h2>
                    <p>Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase.</p>
                    <p>Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${e.message}</p>
                </div>
            `;
        }

        // ğŸŒ Ø¬Ø¹Ù„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹
        window.navigateTo = navigateTo;
        window.goBack = goBack;
        window.logout = logout;
        window.handleLogin = handleLogin;
        window.startNewChallenge = startNewChallenge;
        window.spinWheel = spinWheel;
        window.finishChallenge = finishChallenge;
        window.confirmFinishChallenge = confirmFinishChallenge;
        window.cancelFinishChallenge = cancelFinishChallenge;
        window.deleteCurrentChallenge = deleteCurrentChallenge;
        window.deleteSavedChallenge = deleteSavedChallenge;
        window.viewPlayerDetails = viewPlayerDetails;
        window.applyPointsAdjustment = applyPointsAdjustment;
        window.addGame = addGame;
        window.deleteGame = deleteGame;
        window.addPlayer = addPlayer;
        window.deletePlayer = deletePlayer;
        window.addCard = addCard;
        window.deleteCard = deleteCard;
        window.saveSiteName = saveSiteName;
        window.resetAllData = resetAllData;
        window.resetPoints = resetPoints;
        window.addUser = addUser;
        window.deleteUser = deleteUser;
        window.addNote = addNote;
        window.editNote = editNote;
        window.deleteNote = deleteNote;
        window.toggleSound = toggleSound;
        window.toggleMusic = toggleMusic;
    </script>
</body>
</html>
